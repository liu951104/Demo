<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1 user-scalable=no">
	<title>Canvas绘图</title>
    <script src="https://cdn.staticfile.org/jquery/3.1.1/jquery.min.js"></script>
    <style>
        #img-box{
            margin:0 auto;
            text-align: center;
        }

    </style>
</head>
<body>
    <!-- <canvas class="iCanvas" width="360" height="600"></canvas> -->
    <img src="" alt="" id="res">
    <div id="img-box"></div>
    <script>
        // var canvas = document.getElementById('iCanvas');

        // if(canvas.getContext){
        //     var ctx = canvas.getContext('2d');
        // }

        var Api = {
            //获取页面宽度
            clientWidth:document.body.clientWidth,
            userName:"流了颗星",
            liveName:"周杰伦世界巡回演唱会",
            topicName:"谁在用琵琶弹奏一曲东风破",
            startTime:'2017-06-01',
            speaker:'周杰伦',
            remark:'窗外的麻雀，在电线杆上多嘴，你说这一句，很有夏天的感觉',
            font:'"苹方 常规","微软雅黑"'
        }

        let image = new Image();
        let userImg = new Image();
        let qrcodeImg = new Image();
        image.onload = function(){
            var canvas = document.createElement('canvas');
            var imgW = image.width;
            var imgH = image.height;
            //图片宽高比
            var prop = imgW/imgH;
            var rWidth = Api.clientWidth;
            rWidth > imgW ? rWidth = imgW : rWidth = rWidth;

            image.width = rWidth;
            // image.height = 375/prop;
            console.log(rWidth)
            canvas.width = rWidth;
            canvas.height = rWidth/prop;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(image,0,0,rWidth,rWidth/prop);
            ctx.save();
            ctx.arc(canvas.width / 2, 177, 40, 0, 2 * Math.PI);
            ctx.strokeStyle = "#ffffff";
            ctx.lineWidth = 10;
            ctx.stroke();
            ctx.clip();
            ctx.drawImage(userImg, canvas.width / 2 - 40, 137, 80, 80);
            
            ctx.restore();
            ctx.textAlign = "center";
            ctx.font = "24px " + Api.font;
            ctx.fillStyle = "#4D4D4D";
            ctx.fillText(Api.userName.slice(0, 30), canvas.width / 2, 254);
            ctx.font = "20px " + Api.font;
            ctx.fillStyle = "#999999";
            ctx.fillText("向您推荐一个很棒的课程", canvas.width / 2, 284);
            ctx.font = "22px " + Api.font;
            ctx.fillStyle = "#666666";

            var liveName = Api.liveName;
            liveName.length > 12 && (liveName = liveName.slice(0, 12), liveName += "..."),
            ctx.fillText(liveName, canvas.width / 2, 355),
            ctx.font = "32px " + Api.font,
            ctx.fillStyle = "#4D4D4D";
            var topicName = Api.topicName;
            topicName.length > 24 && (topicName = topicName.slice(0, 24), topicName += "..."),
            topicName.length > 12 && (topicName = topicName.slice(0, 12) + " " + topicName.slice(12)),
            // r(ctx, topicName, canvas.width / 2, 430, 431, 55),
            ctx.font = "bold 20px " + Api.font,
            ctx.fillStyle = "#999999",
            ctx.fillText("开课时间", canvas.width / 2, 563),
            ctx.font = "24px " + Api.font,
            ctx.fillStyle = "#4D4D4D";
            // var o = s(Api.startTime);
            // if (
            //     ctx.fillText(Api.startTime, canvas.width / 2, 600), 
            //     Api.speaker && (ctx.font = "bold 20px " + Api.font, 
            //     ctx.fillStyle = "#999999", 
            //     ctx.fillText("主讲人", canvas.width / 2, 638), 
            //     ctx.font = "24px " + Api.font, ctx.fillStyle = "#4D4D4D", 
            //     Api.speaker = Api.speaker.slice(0, 14), 
            //     ctx.fillText(Api.speaker, canvas.width / 2, 675)), 
            //     Api.remark
            // ) {
            //     ctx.font = "bold 20px " + Api.font,
            //     ctx.fillStyle = "#999999",
            //     ctx.fillText("课程简介", canvas.width / 2, 720),
            //     ctx.font = "22px " + Api.font,
            //     ctx.fillStyle = "#AAAAAA";
            //     var f = Api.remark || "";
            //     f.length > 38 && (f = f.slice(0, 38), f += "...."),
            //     f.length > 19 && (f = f.slice(0, 19) + " " + f.slice(19)),
            //     // r(ctx, f, canvas.width / 2, 757, 431, 34)
            // }
            var h = canvas.width / 2 - 73;
            h = 0 > h ? 0 : h;
            ctx.drawImage(qrcodeImg, h, 888, 146, 146);
            // consolcanvas.log(canvas.toDataURL("image/png"))
            //插入
            var imgBox = document.getElementById("img-box");
            var res = document.getElementById("res");
            // res.src = canvas.toDataURL("image/png");
            
            imgBox.appendChild(canvas);
            return canvas


        }

        // 如果图片跨域
        image.setAttribute('crossOrigin', 'anonymous');
        userImg.setAttribute('crossOrigin', 'anonymous');
        qrcodeImg.setAttribute('crossOrigin', 'anonymous');
        qrcodeImg.src = 'http://img.xingxio.com/test/u/content/res/9/201704/21114323qsjo.jpg';
        userImg.src = 'http://img.xingxio.com/test/wx/content/img/201704/14200501ietx.jpg';
        image.src = 'https://m.qlchat.com/api/wechat/image-proxy?url=https%3A%2F%2Fimg.qlchat.com%2FqlLive%2FadminImg%2FH7J8YHYD-5WQR-IF6C-1494218726230-Z1DIEBX3PB9A.jpg';

    </script>
</body>
</html>